<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>💬 Chat App</title>
  <link rel="stylesheet" href="styles.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="chat-app">
    <div id="sidebar">
      <div id="sidebar-header">💬 Chats</div>
      <ul id="chat-list">
        <li data-chat="public" class="active">🌐 Chat Público</li>
      </ul>
    </div>

    <div id="main">
      <div id="chat-header">
        <img id="chat-avatar" src="" alt="avatar">
        <span id="chat-title">Chat Público</span>
      </div>
      <div id="messages"></div>
      <div id="input-area">
        <input id="message" placeholder="Escribe un mensaje...">
        <button id="send">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let nickname = localStorage.getItem("nickname") || prompt("Tu nombre:");
    let avatar   = localStorage.getItem("avatar") || "https://api.dicebear.com/7.x/identicon/svg?seed=" + nickname;
    localStorage.setItem("nickname", nickname);
    localStorage.setItem("avatar", avatar);

    let currentChat = "public";
    let currentTarget = null;

    const chatList = document.getElementById("chat-list");
    const messages = document.getElementById("messages");
    const chatTitle = document.getElementById("chat-title");
    const chatAvatar = document.getElementById("chat-avatar");
    const messageInput = document.getElementById("message");
    const sendBtn = document.getElementById("send");

    // función para añadir mensajes
    function addMessage(msg) {
      const div = document.createElement("div");
      div.classList.add("message");

      const avatarImg = document.createElement("img");
      avatarImg.src = msg.avatar || "https://via.placeholder.com/40";
      avatarImg.classList.add("avatar");

      const content = document.createElement("div");
      content.classList.add("content");

      const header = document.createElement("div");
      header.classList.add("header");
      header.textContent = msg.name;

      const body = document.createElement("div");
      body.classList.add("body");
      if (msg.text) body.textContent = msg.text;
      if (msg.image) {
        const img = document.createElement("img");
        img.src = msg.image;
        img.classList.add("msg-img");
        body.appendChild(img);
      }

      content.appendChild(header);
      content.appendChild(body);

      div.appendChild(avatarImg);
      div.appendChild(content);

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // recibir mensajes
    socket.on("chat public", msg => { if (currentChat === "public") addMessage(msg); });
    socket.on("chat private", msg => { if (currentChat === "private" && msg.target === nickname) addMessage(msg); });
    socket.on("chat group", msg => { if (currentChat === "group" && msg.groupName === currentTarget) addMessage(msg); });

    // enviar mensaje
    sendBtn.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (!text) return;

      const msgObj = {
        name: nickname,
        avatar,
        text,
        image: null,
        time: Date.now()
      };

      if (currentChat === "public") {
        msgObj.type = "public";
        socket.emit("chat public", msgObj);
      } else if (currentChat === "private") {
        msgObj.type = "private";
        msgObj.target = currentTarget;
        socket.emit("chat private", msgObj);
      } else if (currentChat === "group") {
        msgObj.type = "group";
        msgObj.groupName = currentTarget;
        socket.emit("chat group", msgObj);
      }

      messageInput.value = "";
    });

    // mostrar avatar en cabecera
    chatAvatar.src = avatar;
  </script>
</body>
</html>
