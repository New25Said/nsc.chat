<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ’¬ Chat en Tiempo Real</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="chat-app">
    <!-- Barra lateral con chats, bÃºsqueda y creaciÃ³n de grupos -->
    <div id="sidebar">
      <div id="sidebar-header">Chats</div>
      <input type="text" id="search-contact" placeholder="Buscar contacto o grupo...">
      <ul id="chat-list">
        <!-- Chat pÃºblico por defecto -->
        <li class="public" data-type="public" data-target="General">General</li>
      </ul>
      <!-- Interfaz grÃ¡fica para creaciÃ³n de grupos -->
      <div id="group-creation">
        <h3>Crear Nuevo Grupo</h3>
        <input type="text" id="group-name" placeholder="Nombre del grupo (ej: Amigos)">
        <input type="text" id="group-members" placeholder="Miembros (separados por coma, ej: Juan, Maria)">
        <button id="create-group-btn">Crear Grupo</button>
      </div>
    </div>

    <!-- Panel principal de chat -->
    <div id="chat-panel">
      <div id="chat-header-panel">
        <span id="chat-title">General</span>
        <!-- BotÃ³n para agregar cÃ³digo como "Admin" al lado del nombre -->
        <button id="code-btn" class="code-button">Admin</button>
      </div>
      <div id="messages"></div>
      <div id="input-area">
        <button id="image-btn">ðŸ“Ž</button> <!-- BotÃ³n para adjuntar imÃ¡genes -->
        <input type="text" id="message-input" placeholder="Escribe un mensaje...">
        <button id="send-btn">âž¤</button>
      </div>
    </div>

    <!-- Modal para ingresar nickname -->
    <div id="nickname-modal">
      <input type="text" id="nickname-input" placeholder="Tu nombre de usuario...">
      <button id="join-btn">Unirse</button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
  <script src="notifications.js"></script>
  <script>
    // Variables globales
    const socket = io();
    let nickname = '';
    let currentChatType = 'public'; // public, private, group
    let currentChatTarget = 'General'; // Nombre del target (usuario o grupo)
    let unreadCounts = {}; // Para badges de no leÃ­dos
    let typingTimeouts = {}; // Para indicadores de escritura

    // Mostrar modal de nickname al cargar
    const modal = document.getElementById('nickname-modal');
    modal.style.display = 'flex';

    // Unirse al chat
    document.getElementById('join-btn').addEventListener('click', () => {
      nickname = document.getElementById('nickname-input').value.trim();
      if (nickname) {
        socket.emit('set nickname', nickname);
        modal.style.display = 'none';
      } else {
        alert('Ingresa un nombre vÃ¡lido.');
      }
    });

    // Cambiar chat al hacer clic en la lista
    document.getElementById('chat-list').addEventListener('click', (e) => {
      if (e.target.tagName === 'LI') {
        const type = e.target.dataset.type;
        const target = e.target.dataset.target;
        switchChat(type, target);
        // Resetear badge de no leÃ­dos
        unreadCounts[`${type}-${target}`] = 0;
        updateUnreadBadge(e.target);
      }
    });

    // FunciÃ³n para cambiar de chat
    function switchChat(type, target) {
      currentChatType = type;
      currentChatTarget = target;
      document.getElementById('chat-title').textContent = target;
      // Limpiar mensajes y recargar historial relevante
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      loadChatHistory(type, target);
    }

    // Cargar historial de chat (filtrado por tipo y target)
    function loadChatHistory(type, target) {
      // Enviar solicitud al servidor por historial filtrado (asumiendo que el server lo maneja)
      socket.emit('request history', { type, target });
    }

    // Recibir historial
    socket.on('chat history', (history) => {
      history.forEach(msg => displayMessage(msg));
    });

    // Crear grupo
    document.getElementById('create-group-btn').addEventListener('click', () => {
      const groupName = document.getElementById('group-name').value.trim();
      const membersInput = document.getElementById('group-members').value.trim();
      if (!groupName || !membersInput) {
        alert('Completa los campos.');
        return;
      }
      const members = membersInput.split(',').map(m => m.trim()).filter(m => m);
      if (members.length < 1) {
        alert('Agrega al menos un miembro.');
        return;
      }
      socket.emit('create group', { groupName, members });
      document.getElementById('group-name').value = '';
      document.getElementById('group-members').value = '';
    });

    // Actualizar lista de grupos
    socket.on('group list', (groupList) => {
      const chatList = document.getElementById('chat-list');
      // Mantener el pÃºblico
      chatList.innerHTML = '<li class="public" data-type="public" data-target="General">General</li>';
      groupList.forEach(group => {
        const li = document.createElement('li');
        li.classList.add('group');
        li.dataset.type = 'group';
        li.dataset.target = group;
        li.innerHTML = `${group} <span class="unread-badge" style="display:none;"></span>`;
        chatList.appendChild(li);
      });
    });

    // Actualizar lista de usuarios (para chats privados)
    socket.on('user list', (userList) => {
      const chatList = document.getElementById('chat-list');
      userList.forEach(user => {
        if (user !== nickname) { // No mostrar uno mismo
          const li = document.createElement('li');
          li.classList.add('contact');
          li.dataset.type = 'private';
          li.dataset.target = user;
          li.innerHTML = `${user} <span class="unread-badge" style="display:none;"></span>`;
          chatList.appendChild(li);
        }
      });
    });

    // Enviar mensaje
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const input = document.getElementById('message-input');
      const msg = input.value.trim();
      if (!msg) return;
      const event = currentChatType === 'public' ? 'chat public' :
                    currentChatType === 'private' ? 'chat private' :
                    'chat group';
      const payload = currentChatType === 'public' ? msg :
                      currentChatType === 'private' ? { text: msg, target: currentChatTarget } :
                      { text: msg, groupName: currentChatTarget };
      socket.emit(event, payload);
      input.value = '';
    }

    // Adjuntar imagen
    document.getElementById('image-btn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const data = ev.target.result;
            const event = currentChatType === 'public' ? 'chat public' :
                          currentChatType === 'private' ? 'chat private' :
                          'chat group';
            const payload = currentChatType === 'public' ? { type: 'image', data } :
                            currentChatType === 'private' ? { type: 'image', data, target: currentChatTarget } :
                            { type: 'image', data, groupName: currentChatTarget };
            socket.emit(event, payload);
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    });

    // Recibir mensaje
    socket.on('chat message', (msg) => {
      // Si no es el chat actual, incrementar no leÃ­dos
      const key = `${msg.type}-${msg.target || 'General'}`;
      if (msg.type !== currentChatType || msg.target !== currentChatTarget) {
        unreadCounts[key] = (unreadCounts[key] || 0) + 1;
        updateUnreadBadges();
      }
      displayMessage(msg);
    });

    // Mostrar mensaje en UI
    function displayMessage(msg) {
      if (msg.type !== currentChatType || (msg.target && msg.target !== currentChatTarget)) return;
      const messagesDiv = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', msg.name === nickname ? 'you' : 'other');
      let codeHtml = '';
      if (msg.code) {
        codeHtml = `<button class="code-button">${msg.code}</button>`;
      }
      messageDiv.innerHTML = `
        <span class="name">${msg.name} ${codeHtml}</span>
        <span class="text">${msg.text || ''}</span>
        ${msg.image ? `<img src="${msg.image}" class="chat-image" alt="Imagen enviada">` : ''}
        <span class="time">${new Date(msg.time).toLocaleTimeString()}</span>
      `;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Actualizar badges de no leÃ­dos
    function updateUnreadBadges() {
      document.querySelectorAll('#chat-list li').forEach(li => {
        const key = `${li.dataset.type}-${li.dataset.target}`;
        const badge = li.querySelector('.unread-badge');
        if (badge) {
          badge.textContent = unreadCounts[key] || '';
          badge.style.display = unreadCounts[key] > 0 ? 'inline-block' : 'none';
        }
      });
    }

    function updateUnreadBadge(li) {
      const badge = li.querySelector('.unread-badge');
      if (badge) {
        badge.textContent = '';
        badge.style.display = 'none';
      }
    }

    // Indicador de escritura
    document.getElementById('message-input').addEventListener('input', () => {
      socket.emit('typing', { type: currentChatType, target: currentChatTarget });
    });

    socket.on('typing', ({ name, type, target }) => {
      if (type !== currentChatType || target !== currentChatTarget) return;
      const key = `${type}-${target}`;
      clearTimeout(typingTimeouts[key]);
      // Mostrar "name estÃ¡ escribiendo..." (puedes agregar un div para esto)
      console.log(`${name} estÃ¡ escribiendo...`); // Placeholder, expande con UI
      typingTimeouts[key] = setTimeout(() => {
        // Limpiar indicador
      }, 3000);
    });

    // BotÃ³n para agregar cÃ³digo "Admin" (ejemplo: envÃ­a al server para asociar)
    document.getElementById('code-btn').addEventListener('click', () => {
      // LÃ³gica para togglear o setear cÃ³digo
      socket.emit('set code', 'Admin'); // Asumiendo que el server maneja esto
    });

    // Recibir confirmaciÃ³n de cÃ³digo (agregar a mensajes futuros)
    socket.on('code set', (code) => {
      // Actualizar UI o lÃ³gica local
      alert(`CÃ³digo establecido: ${code}`);
    });

    // BÃºsqueda en sidebar
    document.getElementById('search-contact').addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      document.querySelectorAll('#chat-list li').forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(search) ? 'block' : 'none';
      });
    });

    // Manejar desconexiÃ³n/reconexiÃ³n
    socket.on('disconnect', () => {
      console.log('Desconectado del servidor.');
    });

    socket.on('connect', () => {
      console.log('Conectado al servidor.');
      if (nickname) socket.emit('set nickname', nickname);
    });
  </script>
</body>
</html>
