<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Chat WhatsApp Style</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="chat-app">
  <div id="sidebar">
    <div id="sidebar-header">
      <span class="title">ðŸ’¬ Chat</span>
      <div class="pill">
        <img src="default-avatar.png" alt="avatar" class="pill-avatar" id="my-avatar">
        <span id="pill-nickname">Usuario</span>
        <button class="btn" id="change-nickname-btn">âœŽ</button>
      </div>
    </div>
    <input id="search-contact" placeholder="Buscar..."/>
    <ul id="chat-list"></ul>
    <button id="create-group-btn">Crear Grupo</button>
  </div>

  <div id="chat-panel">
    <div id="chat-header-panel">
      <img id="chat-target-avatar" src="default-avatar.png" class="pill-avatar">
      <span id="chat-title">General</span>
      <span id="typing-indicator"></span>
    </div>
    <ul id="messages"></ul>
    <div id="input-area">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
      <input type="file" id="image-input" accept="image/*" style="display:none"/>
      <button id="image-btn">ðŸ“Ž</button>
      <button id="send-btn">âž¤</button>
    </div>
  </div>
</div>

<div id="nickname-modal">
  <input id="username" placeholder="Escribe tu nickname"/>
  <input type="file" id="avatar-input" accept="image/*" style="display:none"/>
  <button id="join-btn">Unirse</button>
  <button id="upload-avatar-btn">Subir Avatar</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let nickname = localStorage.getItem("nickname") || "";
let avatar = localStorage.getItem("avatar") || "default-avatar.png";
let currentChat = "public";
let currentTarget = null;
let allMessages = [];
let unreadCounts = {};

const nicknameModal = document.getElementById("nickname-modal");
const usernameInput = document.getElementById("username");
const joinBtn = document.getElementById("join-btn");
const messages = document.getElementById("messages");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const typingIndicator = document.getElementById("typing-indicator");
const chatList = document.getElementById("chat-list");
const chatTitle = document.getElementById("chat-title");
const chatTargetAvatar = document.getElementById("chat-target-avatar");
const createGroupBtn = document.getElementById("create-group-btn");
const imageInput = document.getElementById("image-input");
const imageBtn = document.getElementById("image-btn");
const myAvatar = document.getElementById("my-avatar");
const pillNickname = document.getElementById("pill-nickname");
const changeNicknameBtn = document.getElementById("change-nickname-btn");
const avatarInput = document.getElementById("avatar-input");
const uploadAvatarBtn = document.getElementById("upload-avatar-btn");

myAvatar.src = avatar;
pillNickname.textContent = nickname || "Usuario";

// --- FunciÃ³n para agregar mensajes ---
function addMessage(msg){
  const li = document.createElement("li");
  li.className = "message " + (msg.name === nickname ? "you" : "other");
  let content = `<img src='${msg.avatar || 'default-avatar.png'}' class='chat-image-mini'><span class='name'>${msg.name}</span>`;
  if(msg.text) content += `<span class='text'>${msg.text}</span>`;
  if(msg.image) content += `<img src='${msg.image}' class='chat-image'/>`;
  content += `<span class='time'>${new Date(msg.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  li.innerHTML = content;
  messages.appendChild(li);
  messages.scrollTop = messages.scrollHeight;
}

// --- Renderizar mensajes segÃºn chat ---
function renderMessages(){
  messages.innerHTML = "";
  allMessages.forEach(msg => {
    if(currentChat === "public" && msg.type === "public") addMessage(msg);
    else if(currentChat === "private" && msg.type === "private"){
      if((msg.name===nickname && msg.target===currentTarget) || (msg.name===currentTarget && msg.target===nickname)) addMessage(msg);
    } else if(currentChat === "group" && msg.type === "group" && msg.target===currentTarget) addMessage(msg);
  });
}

// --- Agregar item a la lista de chats ---
function addChatListItem(name, type){
  const li = document.createElement("li");
  li.textContent = name;
  li.className = type;
  li.addEventListener("click", () => selectChat(type, name));
  chatList.appendChild(li);
}

// --- Socket Events ---
socket.on("connect", () => {
  if(nickname){
    socket.emit("set nickname", nickname);
    nicknameModal.style.display = "none";
  } else {
    nicknameModal.style.display = "flex";
  }
});

socket.on("chat history", history => { allMessages = history; renderMessages(); });

socket.on("chat message", msg => {
  allMessages.push(msg);
  renderMessages();
});

socket.on("user list", users => {
  chatList.innerHTML = "";
  addChatListItem("General", "public"); // Siempre mostrar chat pÃºblico
  users.forEach(user => {
    if(user !== nickname) addChatListItem(user, "contact");
  });
});

socket.on("group list", groups => { groups.forEach(group => addChatListItem(group, "group")); });

// --- Enviar mensaje ---
sendBtn.addEventListener("click", () => {
  const text = messageInput.value.trim();
  if(!nickname || (!text && !imageInput.files[0])) return;

  const msgObj = { name: nickname, avatar, text, time: Date.now() };

  if(currentChat === "public") socket.emit("chat public", msgObj);
  else if(currentChat === "private") { msgObj.target = currentTarget; socket.emit("chat private", msgObj); }
  else if(currentChat === "group") { msgObj.groupName = currentTarget; socket.emit("chat group", msgObj); }

  messageInput.value="";
});
messageInput.addEventListener("keypress", e => { if(e.key==="Enter") sendBtn.click(); });

// --- Cambiar nickname ---
changeNicknameBtn.addEventListener("click", () => { nicknameModal.style.display="flex"; usernameInput.value = nickname; });
joinBtn.addEventListener("click", () => {
  const name = usernameInput.value.trim();
  if(!name) return;
  nickname=name;
  localStorage.setItem("nickname", nickname);
  pillNickname.textContent=nickname;
  nicknameModal.style.display="none";
  socket.emit("set nickname", nickname);
});

// --- Avatar ---
uploadAvatarBtn.addEventListener("click", () => avatarInput.click());
avatarInput.addEventListener("change", () => {
  const file = avatarInput.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    avatar = reader.result;
    localStorage.setItem("avatar", avatar);
    myAvatar.src = avatar;
    if(currentChat === "private" && currentTarget){
      const msg = allMessages.find(m => m.name === currentTarget && m.avatar);
      chatTargetAvatar.src = msg ? msg.avatar : 'default-avatar.png';
    }
  };
  reader.readAsDataURL(file);
});

// --- Seleccionar chat ---
function selectChat(type, target=null){
  currentChat=type;
  currentTarget=target;
  chatTitle.textContent=target||"General";

  if(type === "private" && target){
    const msg = allMessages.find(m => (m.name === target || m.target === target) && m.avatar);
    chatTargetAvatar.src = msg ? msg.avatar : 'default-avatar.png';
  } else {
    chatTargetAvatar.src = 'default-avatar.png';
  }
  renderMessages();
}
</script>
<script src="notifications.js"></script>
</body>
</html>
