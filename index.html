<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Chat WhatsApp Style</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div id="chat-app">
  <div id="sidebar">
    <div id="sidebar-header">ðŸ’¬ Chat</div>
    <input id="search-contact" placeholder="Buscar..."/>
    <ul id="chat-list"></ul>
    <div id="sidebar-buttons">
      <button id="admin-code-btn">Ingresar CÃ³digo ADMIN</button>
      <button id="create-group-btn">Crear Grupo</button>
    </div>
  </div>

  <div id="chat-panel">
    <div id="chat-header-panel">
      <span id="chat-title">General</span>
      <span id="typing-indicator"></span>
    </div>
    <ul id="messages"></ul>
    <div id="input-area">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
      <input type="file" id="file-input" style="display:none"/>
      <button id="file-btn">ðŸ“Ž</button>
      <button id="send-btn">âž¤</button>
    </div>
  </div>
</div>

<div id="nickname-modal">
  <input id="username" placeholder="Escribe tu nickname"/>
  <button id="join-btn">Unirse</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let nickname = localStorage.getItem("nickname") || "";
let currentChat = "public";
let currentTarget = null;
let allMessages = [];
let unreadCounts = {};
let isAdmin = false;

const nicknameModal = document.getElementById("nickname-modal");
const usernameInput = document.getElementById("username");
const joinBtn = document.getElementById("join-btn");
const messages = document.getElementById("messages");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const typingIndicator = document.getElementById("typing-indicator");
const chatList = document.getElementById("chat-list");
const chatTitle = document.getElementById("chat-title");
const createGroupBtn = document.getElementById("create-group-btn");
const fileInput = document.getElementById("file-input");
const fileBtn = document.getElementById("file-btn");
const adminBtn = document.getElementById("admin-code-btn");

const notificationSound = new Audio("https://ia801505.us.archive.org/10/items/hangouts_sfx/hangouts_message.mp3");

// Archivos
fileBtn.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", () => {
  const file = fileInput.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const dataURL = reader.result;
    const fileObj = { type:"file", data:dataURL, name:file.name, mime:file.type };
    if(currentChat==="public") socket.emit("chat public", fileObj);
    else if(currentChat==="private") socket.emit("chat private",{target:currentTarget,...fileObj});
    else if(currentChat==="group") socket.emit("chat group",{groupName:currentTarget,...fileObj});
  };
  reader.readAsDataURL(file);
  fileInput.value="";
});

// Nickname
socket.on("connect", () => {
  if(nickname){ socket.emit("set nickname", nickname); nicknameModal.style.display="none"; }
  else nicknameModal.style.display="flex";
});

joinBtn.addEventListener("click", ()=>{
  const name=usernameInput.value.trim();
  if(name){
    nickname=name;
    localStorage.setItem("nickname",nickname);
    nicknameModal.style.display="none";
    socket.emit("set nickname",nickname);
  }
});

// Mensajes
sendBtn.addEventListener("click", ()=>{
  const text = messageInput.value.trim();
  if(!text||!nickname) return;
  if(currentChat==="public") socket.emit("chat public", text);
  else if(currentChat==="private") socket.emit("chat private",{target:currentTarget,text});
  else if(currentChat==="group") socket.emit("chat group",{groupName:currentTarget,text});
  messageInput.value="";
});

messageInput.addEventListener("keypress", e=>{if(e.key==="Enter") sendBtn.click();});
messageInput.addEventListener("input", ()=>{socket.emit("typing",{type:currentChat,target:currentTarget});});

// Indicador escribiendo
socket.on("typing", data=>{
  if(data.name!==nickname){
    typingIndicator.textContent=`${data.name} estÃ¡ escribiendo...`;
    clearTimeout(window.typingTimeout);
    window.typingTimeout=setTimeout(()=>typingIndicator.textContent="",2000);
  }
});

// ADMIN
adminBtn.addEventListener("click", ()=>{
  const code = prompt("Ingresa el cÃ³digo de Admin:");
  if(code) socket.emit("set admin", code);
});

socket.on("admin update", nicknameAdmin => { if(nicknameAdmin===nickname) isAdmin=true; renderMessages(); });

// Historial
socket.on("chat history", history=>{ allMessages=history; renderMessages(); });
socket.on("chat message", msg=>{
  allMessages.push(msg);
  if(msg.name!==nickname && document.hidden) notificationSound.play().catch(()=>{});

  if(msg.type==="private" && msg.name!==nickname){
    if(currentChat!=="private"||currentTarget!==msg.name){ unreadCounts[msg.name]=(unreadCounts[msg.name]||0)+1; updateUnreadBadge(msg.name); }
  }
  if(msg.type==="group" && msg.name!==nickname){
    if(currentChat!=="group"||currentTarget!==msg.target){ unreadCounts[msg.target]=(unreadCounts[msg.target]||0)+1; updateUnreadBadge(msg.target); }
  }

  renderMessages();
});

// Render mensajes
function addMessage(msg){
  const li=document.createElement("li");
  li.className="message "+(msg.name===nickname?"you":"other");
  let nameHTML=msg.name;
  if(msg.isAdmin||(msg.name===nickname&&isAdmin)) nameHTML+=` <span class="badge-admin">ADMIN</span>`;
  let content=`<span class="name">${nameHTML}</span>`;

  if(msg.image) content+=`<img src="${msg.image}" class="chat-image"/>`;
  if(msg.file){
    if(msg.file.mime.startsWith("image/")) content+=`<img src="${msg.file.data}" class="chat-image"/>`;
    else if(msg.file.mime.startsWith("audio/")) content+=`<audio controls src="${msg.file.data}"></audio>`;
    else content+=`<a href="${msg.file.data}" download="${msg.file.name}">${msg.file.name}</a>`;
  }

  if(msg.text) content+=`<span class="text">${msg.text}</span>`;
  content+=`<span class="time">${new Date(msg.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  li.innerHTML=content;
  messages.appendChild(li);
  messages.scrollTop=messages.scrollHeight;
}

function renderMessages(){
  messages.innerHTML="";
  allMessages.forEach(msg=>{
    if(currentChat==="public"&&msg.type==="public") addMessage(msg);
    else if(currentChat==="private"&&msg.type==="private"){
      if((msg.name===nickname&&msg.target===currentTarget)||(msg.name===currentTarget&&msg.target===nickname)) addMessage(msg);
    } else if(currentChat==="group"&&msg.type==="group"&&msg.target===currentTarget) addMessage(msg);
  });
}

// Badges
function updateUnreadBadge(nameOrGroup){
  const lis=chatList.querySelectorAll("li");
  lis.forEach(li=>{
    if(li.textContent.startsWith(nameOrGroup)){
      const oldBadge=li.querySelector(".unread-badge"); if(oldBadge) oldBadge.remove();
      const count=unreadCounts[nameOrGroup]; if(count>0){ const badge=document.createElement("span"); badge.className="unread-badge"; badge.textContent=count; li.appendChild(badge); }
    }
  });
}

// Usuarios
socket.on("user list", users=>{
  chatList.innerHTML="";
  const generalLi=document.createElement("li");
  generalLi.textContent="General"; generalLi.className="public"; generalLi.addEventListener("click",()=>selectChat("public"));
  chatList.appendChild(generalLi);
  users.forEach(user=>{ if(user!==nickname){ const li=document.createElement("li"); li.textContent=user; li.className="contact"; li.addEventListener("click",()=>selectChat("private",user)); chatList.appendChild(li); }});
});

// Grupos
socket.on("group list", groups=>{
  groups.forEach(group=>{
    const li=document.createElement("li");
    li.textContent=group;
    li.className="group";
    li.addEventListener("click",()=>selectChat("group",group));
    chatList.appendChild(li);
  });
});

// Crear grupo
createGroupBtn.addEventListener("click",()=>{
  const name=prompt("Nombre del grupo:");
  const members=prompt("Miembros separados por coma:").split(",").map(m=>m.trim());
  if(name && members.length>0){ members.push(nickname); socket.emit("create group",{groupName:name,members}); }
});

function selectChat(type,target=null){
  currentChat=type; currentTarget=target; chatTitle.textContent=target||"General";
  if(target && unreadCounts[target]){ delete unreadCounts[target]; updateUnreadBadge(target); }
  renderMessages();
}
</script>

</body>
</html>
